#!/bin/bash
set -euo pipefail

{{- if not .isEphemeral }}
gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Setting up third-party repositories"

for repo in free nonfree; do
  gum spin --spinner points --title "Installing RPM Fusion ${repo}" -- \
    sudo dnf install -y -q "https://download1.rpmfusion.org/${repo}/fedora/rpmfusion-${repo}-release-$(rpm -E %fedora).noarch.rpm" >/dev/null 2>&1
done

for repo in avengemedia/dms dulikiles/vicinae errornointernet/quickshell skoved/vivid; do
  gum spin --spinner points --title "Enabling COPR ${repo##*/}" -- \
    sudo dnf copr enable -y "${repo}" >/dev/null 2>&1
done

if ! rpm -q terra-release &>/dev/null; then
  gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Installing Terra repository"
  sudo dnf install -y -q --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release >/dev/null 2>&1
fi

sudo tee /etc/yum.repos.d/google-chrome.repo >/dev/null <<'EOR'
[google-chrome]
name=google-chrome
baseurl=https://dl.google.com/linux/chrome/rpm/stable/x86_64
enabled=1
gpgcheck=0
EOR

sudo tee /etc/yum.repos.d/vscode.repo >/dev/null <<'EOR'
[code]
name=Visual Studio Code
baseurl=https://packages.microsoft.com/yumrepos/vscode
enabled=1
gpgcheck=0
EOR

sudo tee /etc/yum.repos.d/fury.repo >/dev/null <<'EOR'
[carapace]
name=Gemfury Carapace Repo
baseurl=https://yum.fury.io/rsteube/
enabled=1
gpgcheck=0

[nushell]
name=Gemfury Nushell Repo
baseurl=https://yum.fury.io/nushell/
enabled=1
gpgcheck=0
EOR

gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Third-party repositories configured"
{{- end }}

gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Installing dnf groups and packages"

{{- $rpmGroups := list "core" "rpm-development-tools" }}

{{- $devTools := list "cargo" "cmake" "golang" "nodejs" "npm" "rustc" }}
{{- $editors := list "neovim" }}
{{- $terminalTools := list "bat" "fzf" "glow" "gum" "ripgrep" "tmux" "zsh" }}
{{- $systemTools := list "jq" "podman-compose" "sshpass" "yq" }}

{{- if not .isEphemeral }}
{{-   $rpmGroups = concat $rpmGroups (list "admin-tools" "container-management" "development-tools" "multimedia") }}
{{-   $devTools = concat $devTools (list "gh" "git-credential-libsecret" "git-delta" "git-lfs" "gitui" "glab" "tokei" "uv") }}
{{-   $editors = concat $editors (list "code" "helix") }}
{{-   $fonts := list "ia-writer-nerd-fonts" "maple-fonts" "nerdfontssymbolsonly-nerd-fonts" "rsms-inter-vf-fonts" "sarasa-gothic-fonts" -}}
{{-   $terminalTools = concat $terminalTools (list "atuin" "carapace-bin" "direnv" "eza" "fastfetch" "fd" "ghostty" "gpaste" "just" "kitty" "lnav" "mise" "nushell" "rio" "sheldon" "starship" "zoxide") }}
{{-   $uiTools := list "dms" "flatpak" "matugen" "niri" "qt6-qtmultimedia" "qt6-qtsvg" "qt6-qtvirtualkeyboard" "quickshell" "sddm" "vicinae" -}}
{{-   $systemTools = concat $systemTools (list "age" "bottom" "brightnessctl" "cava" "cliphist" "conserver" "duf" "fcitx5-rime" "gammastep" "librime-lua" "lxqt-policykit" "matugen" "procs" "rbw" "tealdeer" "udiskie" "vivid") -}}
{{-   $allPackages := concat $devTools $editors $fonts $terminalTools $uiTools $systemTools }}

gum spin --spinner points --title "Installing package groups" -- \
  sudo dnf group install -y -q --skip-broken{{ range $rpmGroups }} "{{ . }}"{{- end }}

gum spin --spinner points --title "Installing individual packages" -- \
  sudo dnf install -y -q --skip-broken{{ range $allPackages }} {{ . }}{{- end }}
{{- else }}
{{-   $allPackages := concat $devTools $editors $terminalTools $systemTools }}

gum spin --spinner points --title "Installing package groups" -- \
  sudo dnf group install -y -q --skip-broken{{ range $rpmGroups }} "{{ . }}"{{- end }}

gum spin --spinner points --title "Installing individual packages" -- \
  sudo dnf install -y -q --skip-broken{{ range $allPackages }} {{ . }}{{- end }}
{{- end }}
