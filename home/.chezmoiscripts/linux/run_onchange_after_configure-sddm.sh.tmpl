#!/bin/bash

set -e

THEME_NAME="astronaut"
THEME_VARIANT="pixel_sakura"
THEMES_DIR="/usr/share/sddm/themes"
THEME_DIR="${THEMES_DIR}/${THEME_NAME}"
METADATA="${THEME_DIR}/metadata.desktop"

gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Configuring SDDM with Astronaut theme"

if ! command -v sddm &>/dev/null; then
  gum log --level warn --level.foreground "{{ .visual.nord.nord13 }}" "SDDM is not installed, skipping configuration"
  exit 0
fi

if [ ! -d "${THEME_DIR}" ]; then
  gum spin --spinner points --title "Installing SDDM Astronaut Theme" -- \
    sudo git clone --depth 1 https://github.com/Keyitdev/sddm-astronaut-theme.git "${THEME_DIR}"

  if [ -d "${THEME_DIR}/Fonts" ]; then
    gum spin --spinner points --title "Installing fonts" -- bash -c "
      sudo cp -r '${THEME_DIR}/Fonts'/* /usr/share/fonts/
      sudo fc-cache -f
    "
  fi

  gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Theme installed at ${THEME_DIR}"
else
  gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Theme already installed at ${THEME_DIR}"
fi

sudo mkdir -p /etc/sddm.conf.d

cat <<EOF | sudo tee /etc/sddm.conf.d/theme.conf >/dev/null
[Theme]
Current=${THEME_NAME}
EOF

cat <<EOF | sudo tee /etc/sddm.conf.d/wayland.conf >/dev/null
[General]
InputMethod=qtvirtualkeyboard
DisplayServer=wayland
Numlock=on

[Wayland]
SessionDir=/usr/share/wayland-sessions

[X11]
SessionDir=/dev/null
EOF

if [ -f "${METADATA}" ]; then
  gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Selecting theme variant: ${THEME_VARIANT}"
  sudo sed -i "s|^ConfigFile=.*|ConfigFile=Themes/${THEME_VARIANT}.conf|" "${METADATA}"
else
  gum log --level warn --level.foreground "{{ .visual.nord.nord13 }}" "metadata.desktop not found at ${METADATA}"
fi

if command -v fprintd-list &>/dev/null; then
  gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Configuring fingerprint authentication"
  PAM_SDDM="/etc/pam.d/sddm"

  if [ -f "${PAM_SDDM}" ]; then
    if ! grep -q "pam_fprintd.so" "${PAM_SDDM}"; then
      sudo sed -i '/^auth.*substack.*password-auth$/i auth       sufficient   pam_fprintd.so' "${PAM_SDDM}"
      gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Fingerprint authentication enabled"
    else
      gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "Fingerprint authentication already configured"
    fi
  fi
else
  gum log --level warn --level.foreground "{{ .visual.nord.nord13 }}" "fprintd not installed, skipping fingerprint configuration"
fi

if systemctl is-enabled display-manager.service &>/dev/null; then
  sudo systemctl --quiet disable display-manager.service
fi
sudo systemctl --quiet enable --now sddm.service
sudo systemctl --quiet set-default graphical.target
gum log --level info --level.foreground "{{ .visual.nord.nord14 }}" "SDDM service enabled"
